<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Admin Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background-color: #10b981;
        }

        .status-dot.disconnected {
            background-color: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5568d3;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Connection Panel */
        .connection-panel {
            grid-column: 1 / -1;
        }

        .connection-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
        }

        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .connection-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Message Test Panel */
        .message-type-selector {
            margin-bottom: 15px;
        }

        .message-params {
            background-color: #f9fafb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .param-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .param-label {
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
        }

        .param-input {
            display: flex;
            gap: 10px;
        }

        .param-input input,
        .param-input select {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .message-actions {
            display: flex;
            gap: 10px;
        }

        /* Audio Panel */
        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .audio-status {
            background-color: #f9fafb;
            border-radius: 6px;
            padding: 15px;
            font-size: 14px;
        }

        .audio-status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .audio-status-label {
            color: #6b7280;
        }

        .audio-status-value {
            font-weight: 600;
            color: #111827;
        }

        .audio-visualizer {
            height: 100px;
            background-color: #f9fafb;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .audio-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            height: 80px;
        }

        .audio-bar {
            width: 4px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        /* Logs Panel */
        .logs-panel {
            grid-column: 1 / -1;
        }

        .logs-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .log-container {
            background-color: #1e1e1e;
            border-radius: 6px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            line-height: 1.5;
        }

        .log-entry.sent {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }

        .log-entry.received {
            background-color: rgba(16, 185, 129, 0.1);
            border-left: 3px solid #10b981;
        }

        .log-entry.error {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
        }

        .log-entry.info {
            background-color: rgba(107, 114, 128, 0.1);
            border-left: 3px solid #6b7280;
        }

        .log-timestamp {
            color: #9ca3af;
            font-size: 11px;
            margin-right: 8px;
        }

        .log-type {
            font-weight: 600;
            margin-right: 8px;
        }

        .log-type.sent {
            color: #3b82f6;
        }

        .log-type.received {
            color: #10b981;
        }

        .log-type.error {
            color: #ef4444;
        }

        .log-type.info {
            color: #9ca3af;
        }

        .log-content {
            color: #d1d5db;
            word-break: break-all;
        }

        /* Scrollbar */
        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .log-container::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 4px;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background-color: #f9fafb;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¯ WebSocket Admin Console</h1>
            <p style="color: #6b7280; margin-top: 5px;">å³æ™‚ç›£æ§å’Œæ¸¬è©¦ WebSocket é€£ç·š</p>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot disconnected" id="statusDot"></div>
                    <span id="statusText">æœªé€£ç·š</span>
                </div>
                <div class="stats-grid" style="flex: 1;">
                    <div class="stat-card">
                        <div class="stat-value" id="sentCount">0</div>
                        <div class="stat-label">å·²ç™¼é€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="receivedCount">0</div>
                        <div class="stat-label">å·²æ¥æ”¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="audioChunks">0</div>
                        <div class="stat-label">éŸ³è¨Šå€å¡Š</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-grid">
            <!-- Connection Panel -->
            <div class="panel connection-panel">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ”Œ é€£ç·šè¨­å®š</h2>
                </div>
                <div class="connection-controls">
                    <div class="form-group">
                        <label>Meeting ID</label>
                        <input type="text" id="meetingId" value="admin_test_meeting" placeholder="è¼¸å…¥æœƒè­° ID">
                    </div>
                    <div class="form-group">
                        <label>Speaker ID</label>
                        <input type="text" id="speakerId" value="admin_speaker" placeholder="è¼¸å…¥è¬›è€… ID">
                    </div>
                    <div class="form-group">
                        <label>Speaker Name</label>
                        <input type="text" id="speakerName" value="Admin User" placeholder="è¼¸å…¥è¬›è€…åç¨±">
                    </div>
                    <div class="form-group">
                        <label>Device ID</label>
                        <input type="text" id="deviceId" value="admin_device_001" placeholder="è¼¸å…¥è¨­å‚™ ID">
                    </div>
                </div>
                <div class="connection-buttons">
                    <button class="btn btn-success" id="connectBtn">ğŸ”— é€£ç·š</button>
                    <button class="btn btn-danger" id="disconnectBtn" disabled>ğŸ”Œ æ–·ç·š</button>
                    <button class="btn btn-secondary" id="reconnectBtn" disabled>ğŸ”„ é‡æ–°é€£ç·š</button>
                </div>
            </div>

            <!-- Message Test Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ’¬ è¨Šæ¯æ¸¬è©¦</h2>
                </div>
                <div class="message-type-selector">
                    <div class="form-group">
                        <label>è¨Šæ¯é¡å‹</label>
                        <select id="messageType">
                            <option value="">-- é¸æ“‡è¨Šæ¯é¡å‹ --</option>
                            <option value="set_translate">è¨­å®šç¿»è­¯é–‹é—œ (set_translate)</option>
                            <option value="set_prev_text">è¨­å®šå‰æ–‡ (set_prev_text)</option>
                            <option value="set_post_processing">è¨­å®šå¾Œè™•ç† (set_post_processing)</option>
                            <option value="set_language">è¨­å®šèªè¨€ (set_language)</option>
                            <option value="set_meeting_id">è¨­å®šæœƒè­° ID (set_meeting_id)</option>
                            <option value="set_recording_id">è¨­å®šéŒ„éŸ³ ID (set_recording_id)</option>
                            <option value="set_speaker">è¨­å®šè¬›è€…è³‡è¨Š (set_speaker)</option>
                            <option value="set_device_id">è¨­å®šè¨­å‚™ ID (set_device_id)</option>
                            <option value="clear_stt_queue">æ¸…é™¤ STT ä½‡åˆ— (clear_stt_queue)</option>
                            <option value="set_pre_buffer">è¨­å®šé ç·©è¡ (set_pre_buffer)</option>
                            <option value="set_silent_duration">è¨­å®šéœéŸ³æ™‚é•· (set_silent_duration)</option>
                            <option value="get_prams">å–å¾—åƒæ•¸ (get_prams)</option>
                            <option value="ping">Ping æ¸¬è©¦</option>
                        </select>
                    </div>
                </div>
                <div class="message-params" id="messageParams">
                    <p style="color: #6b7280; text-align: center;">è«‹é¸æ“‡è¨Šæ¯é¡å‹</p>
                </div>
                <div class="message-actions">
                    <button class="btn btn-primary" id="sendMessageBtn" disabled>ğŸ“¤ ç™¼é€è¨Šæ¯</button>
                    <button class="btn btn-secondary" id="clearParamsBtn">ğŸ—‘ï¸ æ¸…é™¤</button>
                </div>
            </div>

            <!-- Audio Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">ğŸ¤ éŸ³è¨Šä¸²æµ</h2>
                </div>
                <div class="audio-controls">
                    <div class="form-group">
                        <label>é¸æ“‡éº¥å…‹é¢¨</label>
                        <select id="microphoneSelect">
                            <option value="">-- é¸æ“‡éº¥å…‹é¢¨ --</option>
                        </select>
                    </div>
                    <button class="btn btn-success" id="startAudioBtn" disabled>ğŸ™ï¸ é–‹å§‹éŒ„éŸ³</button>
                    <button class="btn btn-danger" id="stopAudioBtn" disabled>â¹ï¸ åœæ­¢éŒ„éŸ³</button>
                    <div class="audio-status">
                        <div class="audio-status-item">
                            <span class="audio-status-label">éŒ„éŸ³ç‹€æ…‹:</span>
                            <span class="audio-status-value" id="audioStatus">æœªé–‹å§‹</span>
                        </div>
                        <div class="audio-status-item">
                            <span class="audio-status-label">å·²ç™¼é€å€å¡Š:</span>
                            <span class="audio-status-value" id="audioChunksValue">0</span>
                        </div>
                        <div class="audio-status-item">
                            <span class="audio-status-label">éŒ„éŸ³æ™‚é•·:</span>
                            <span class="audio-status-value" id="audioDuration">0.0s</span>
                        </div>
                    </div>
                    <div class="audio-visualizer">
                        <div class="audio-bars" id="audioBars">
                            <!-- Audio bars will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Panel -->
        <div class="panel logs-panel">
            <div class="panel-header">
                <h2 class="panel-title">ğŸ“‹ è¨Šæ¯æ—¥èªŒ</h2>
                <div class="logs-controls">
                    <button class="btn btn-secondary" id="clearLogsBtn">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                        <input type="checkbox" id="autoScrollCheckbox" checked>
                        è‡ªå‹•æ²å‹•
                    </label>
                </div>
            </div>
            <div class="log-container" id="logContainer">
                <div class="log-entry info">
                    <span class="log-timestamp">[ç­‰å¾…é€£ç·š]</span>
                    <span class="log-type info">ç³»çµ±</span>
                    <span class="log-content">è«‹é»æ“Šã€Œé€£ç·šã€æŒ‰éˆ•é–‹å§‹</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket Admin Console
        class WebSocketAdminConsole {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.messageCount = { sent: 0, received: 0, audioChunks: 0 };
                this.audioContext = null;
                this.audioStream = null;
                this.audioProcessor = null;
                this.isRecording = false;
                this.audioStartTime = null;
                
                this.initializeUI();
                this.setupEventListeners();
                this.loadMicrophones();
            }

            initializeUI() {
                // Initialize audio visualizer bars
                const audioBars = document.getElementById('audioBars');
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'audio-bar';
                    bar.style.height = '5px';
                    audioBars.appendChild(bar);
                }
            }

            setupEventListeners() {
                // Connection buttons
                document.getElementById('connectBtn').addEventListener('click', () => this.connect());
                document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
                document.getElementById('reconnectBtn').addEventListener('click', () => this.reconnect());

                // Message test
                document.getElementById('messageType').addEventListener('change', (e) => this.updateMessageParams(e.target.value));
                document.getElementById('sendMessageBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('clearParamsBtn').addEventListener('click', () => this.clearParams());

                // Audio controls
                document.getElementById('microphoneSelect').addEventListener('change', (e) => {
                    document.getElementById('startAudioBtn').disabled = !e.target.value || !this.isConnected;
                });
                document.getElementById('startAudioBtn').addEventListener('click', () => this.startAudio());
                document.getElementById('stopAudioBtn').addEventListener('click', () => this.stopAudio());

                // Logs
                document.getElementById('clearLogsBtn').addEventListener('click', () => this.clearLogs());
            }

            async loadMicrophones() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');
                    
                    const select = document.getElementById('microphoneSelect');
                    select.innerHTML = '<option value="">-- é¸æ“‡éº¥å…‹é¢¨ --</option>';
                    
                    audioInputs.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `éº¥å…‹é¢¨ ${index + 1}`;
                        select.appendChild(option);
                    });

                    if (audioInputs.length === 0) {
                        this.addLog('error', 'æœªæ‰¾åˆ°éº¥å…‹é¢¨è¨­å‚™');
                    }
                } catch (error) {
                    this.addLog('error', `è¼‰å…¥éº¥å…‹é¢¨å¤±æ•—: ${error.message}`);
                }
            }

            connect() {
                if (this.isConnected) return;

                const meetingId = document.getElementById('meetingId').value;
                const speakerId = document.getElementById('speakerId').value;
                const speakerName = document.getElementById('speakerName').value;
                const deviceId = document.getElementById('deviceId').value;

                const payload = {
                    meeting_id: meetingId,
                    speaker_id: speakerId,
                    speaker_name: speakerName,
                    recording_id: `admin_${Date.now()}`,
                    device_id: deviceId
                };

                const encodedPayload = encodeURIComponent(JSON.stringify(payload));
                const wsUrl = `ws://${window.location.hostname}:${window.location.port || 80}/S2TT/vad_translate_stream?payload=${encodedPayload}`;

                this.addLog('info', `é€£ç·šè‡³: ${wsUrl}`);

                try {
                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                        this.addLog('info', 'âœ… WebSocket é€£ç·šæˆåŠŸ');
                    };

                    this.ws.onmessage = (event) => {
                        this.messageCount.received++;
                        this.updateStats();
                        
                        try {
                            const data = JSON.parse(event.data);
                            this.addLog('received', JSON.stringify(data, null, 2));
                        } catch (e) {
                            this.addLog('received', event.data);
                        }
                    };

                    this.ws.onerror = (error) => {
                        this.addLog('error', `WebSocket éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                    };

                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                        this.addLog('info', 'ğŸ”Œ WebSocket é€£ç·šå·²é—œé–‰');
                        
                        // Stop audio if recording
                        if (this.isRecording) {
                            this.stopAudio();
                        }
                    };
                } catch (error) {
                    this.addLog('error', `é€£ç·šå¤±æ•—: ${error.message}`);
                }
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
            }

            reconnect() {
                this.disconnect();
                setTimeout(() => this.connect(), 500);
            }

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');
                const reconnectBtn = document.getElementById('reconnectBtn');
                const sendMessageBtn = document.getElementById('sendMessageBtn');
                const startAudioBtn = document.getElementById('startAudioBtn');

                if (connected) {
                    statusDot.classList.remove('disconnected');
                    statusDot.classList.add('connected');
                    statusText.textContent = 'å·²é€£ç·š';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    reconnectBtn.disabled = false;
                    sendMessageBtn.disabled = !document.getElementById('messageType').value;
                    startAudioBtn.disabled = !document.getElementById('microphoneSelect').value;
                } else {
                    statusDot.classList.remove('connected');
                    statusDot.classList.add('disconnected');
                    statusText.textContent = 'æœªé€£ç·š';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    reconnectBtn.disabled = true;
                    sendMessageBtn.disabled = true;
                    startAudioBtn.disabled = true;
                }
            }

            updateMessageParams(messageType) {
                const paramsDiv = document.getElementById('messageParams');
                const sendBtn = document.getElementById('sendMessageBtn');
                
                if (!messageType) {
                    paramsDiv.innerHTML = '<p style="color: #6b7280; text-align: center;">è«‹é¸æ“‡è¨Šæ¯é¡å‹</p>';
                    sendBtn.disabled = true;
                    return;
                }

                sendBtn.disabled = !this.isConnected;
                let paramsHTML = '';

                switch (messageType) {
                    case 'set_translate':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">use_translate:</span>
                                <div class="param-input">
                                    <select id="param_use_translate">
                                        <option value="true">true</option>
                                        <option value="false">false</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_prev_text':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">use_prev_text:</span>
                                <div class="param-input">
                                    <select id="param_use_prev_text">
                                        <option value="">-- ä¸è¨­å®š --</option>
                                        <option value="true">true</option>
                                        <option value="false">false</option>
                                    </select>
                                </div>
                            </div>
                            <div class="param-row">
                                <span class="param-label">prev_text:</span>
                                <div class="param-input">
                                    <input type="text" id="param_prev_text" placeholder="è¼¸å…¥å‰æ–‡å…§å®¹">
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_post_processing':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">use_post_processing:</span>
                                <div class="param-input">
                                    <select id="param_use_post_processing">
                                        <option value="true">true</option>
                                        <option value="false">false</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_language':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">language:</span>
                                <div class="param-input">
                                    <select id="param_language">
                                        <option value="zh">ä¸­æ–‡ (zh)</option>
                                        <option value="en">è‹±æ–‡ (en)</option>
                                        <option value="de">å¾·æ–‡ (de)</option>
                                        <option value="ja">æ—¥æ–‡ (ja)</option>
                                        <option value="ko">éŸ“æ–‡ (ko)</option>
                                    </select>
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_meeting_id':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">meeting_id:</span>
                                <div class="param-input">
                                    <input type="text" id="param_meeting_id" placeholder="è¼¸å…¥æœƒè­° ID">
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_recording_id':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">recording_id:</span>
                                <div class="param-input">
                                    <input type="text" id="param_recording_id" placeholder="è¼¸å…¥éŒ„éŸ³ ID">
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_speaker':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">speaker_id:</span>
                                <div class="param-input">
                                    <input type="text" id="param_speaker_id" placeholder="è¼¸å…¥è¬›è€… ID">
                                </div>
                            </div>
                            <div class="param-row">
                                <span class="param-label">speaker_name:</span>
                                <div class="param-input">
                                    <input type="text" id="param_speaker_name" placeholder="è¼¸å…¥è¬›è€…åç¨±">
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_device_id':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">device_id:</span>
                                <div class="param-input">
                                    <input type="text" id="param_device_id" placeholder="è¼¸å…¥è¨­å‚™ ID">
                                </div>
                            </div>
                        `;
                        break;
                    case 'clear_stt_queue':
                        paramsHTML = '<p style="color: #6b7280; text-align: center;">æ­¤è¨Šæ¯ä¸éœ€è¦åƒæ•¸</p>';
                        break;
                    case 'set_pre_buffer':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">use_pre_buffer:</span>
                                <div class="param-input">
                                    <select id="param_use_pre_buffer">
                                        <option value="">-- ä¸è¨­å®š --</option>
                                        <option value="true">true</option>
                                        <option value="false">false</option>
                                    </select>
                                </div>
                            </div>
                            <div class="param-row">
                                <span class="param-label">pre_buffer_size:</span>
                                <div class="param-input">
                                    <input type="number" id="param_pre_buffer_size" placeholder="è¼¸å…¥ç·©è¡å¤§å°">
                                </div>
                            </div>
                        `;
                        break;
                    case 'set_silent_duration':
                        paramsHTML = `
                            <div class="param-row">
                                <span class="param-label">silent_duration:</span>
                                <div class="param-input">
                                    <input type="number" step="0.1" id="param_silent_duration" placeholder="è¼¸å…¥éœéŸ³æ™‚é•· (ç§’)">
                                </div>
                            </div>
                        `;
                        break;
                    case 'get_prams':
                        paramsHTML = '<p style="color: #6b7280; text-align: center;">æ­¤è¨Šæ¯ä¸éœ€è¦åƒæ•¸</p>';
                        break;
                    case 'ping':
                        paramsHTML = '<p style="color: #6b7280; text-align: center;">æ­¤è¨Šæ¯ä¸éœ€è¦åƒæ•¸</p>';
                        break;
                }

                paramsDiv.innerHTML = paramsHTML;
            }

            sendMessage() {
                if (!this.isConnected || !this.ws) {
                    this.addLog('error', 'è«‹å…ˆé€£ç·š WebSocket');
                    return;
                }

                const messageType = document.getElementById('messageType').value;
                if (!messageType) {
                    this.addLog('error', 'è«‹é¸æ“‡è¨Šæ¯é¡å‹');
                    return;
                }

                const message = { type: messageType };

                // Add parameters based on message type
                switch (messageType) {
                    case 'set_translate':
                        message.use_translate = document.getElementById('param_use_translate').value === 'true';
                        break;
                    case 'set_prev_text':
                        const usePrevText = document.getElementById('param_use_prev_text').value;
                        if (usePrevText) message.use_prev_text = usePrevText === 'true';
                        const prevText = document.getElementById('param_prev_text').value;
                        if (prevText) message.prev_text = prevText;
                        break;
                    case 'set_post_processing':
                        message.use_post_processing = document.getElementById('param_use_post_processing').value === 'true';
                        break;
                    case 'set_language':
                        message.language = document.getElementById('param_language').value;
                        break;
                    case 'set_meeting_id':
                        message.meeting_id = document.getElementById('param_meeting_id').value;
                        break;
                    case 'set_recording_id':
                        message.recording_id = document.getElementById('param_recording_id').value;
                        break;
                    case 'set_speaker':
                        const speakerId = document.getElementById('param_speaker_id').value;
                        const speakerName = document.getElementById('param_speaker_name').value;
                        if (speakerId) message.speaker_id = speakerId;
                        if (speakerName) message.speaker_name = speakerName;
                        break;
                    case 'set_device_id':
                        message.device_id = document.getElementById('param_device_id').value;
                        break;
                    case 'set_pre_buffer':
                        const usePreBuffer = document.getElementById('param_use_pre_buffer').value;
                        if (usePreBuffer) message.use_pre_buffer = usePreBuffer === 'true';
                        const preBufferSize = document.getElementById('param_pre_buffer_size').value;
                        if (preBufferSize) message.pre_buffer_size = parseInt(preBufferSize);
                        break;
                    case 'set_silent_duration':
                        message.silent_duration = parseFloat(document.getElementById('param_silent_duration').value);
                        break;
                }

                try {
                    const messageJson = JSON.stringify(message);
                    this.ws.send(messageJson);
                    this.messageCount.sent++;
                    this.updateStats();
                    this.addLog('sent', messageJson);
                } catch (error) {
                    this.addLog('error', `ç™¼é€è¨Šæ¯å¤±æ•—: ${error.message}`);
                }
            }

            clearParams() {
                document.getElementById('messageType').value = '';
                this.updateMessageParams('');
            }

            async startAudio() {
                if (this.isRecording) return;

                const deviceId = document.getElementById('microphoneSelect').value;
                if (!deviceId) {
                    this.addLog('error', 'è«‹é¸æ“‡éº¥å…‹é¢¨');
                    return;
                }

                if (!this.isConnected) {
                    this.addLog('error', 'è«‹å…ˆé€£ç·š WebSocket');
                    return;
                }

                try {
                    // Request microphone access
                    this.audioStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            deviceId: { exact: deviceId },
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });

                    // Create audio context
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });

                    const source = this.audioContext.createMediaStreamSource(this.audioStream);
                    
                    // Create script processor for audio chunks
                    const bufferSize = 512; // 32ms at 16kHz
                    this.audioProcessor = this.audioContext.createScriptProcessor(bufferSize, 1, 1);

                    this.audioProcessor.onaudioprocess = (e) => {
                        if (!this.isRecording) return;

                        const inputData = e.inputBuffer.getChannelData(0);
                        const audioChunk = new Float32Array(inputData);

                        // Send to WebSocket
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(audioChunk.buffer);
                            this.messageCount.audioChunks++;
                            this.updateStats();

                            // Update visualizer
                            this.updateVisualizer(audioChunk);
                        }
                    };

                    source.connect(this.audioProcessor);
                    this.audioProcessor.connect(this.audioContext.destination);

                    this.isRecording = true;
                    this.audioStartTime = Date.now();
                    this.updateAudioStatus('éŒ„éŸ³ä¸­', true);
                    this.addLog('info', 'ğŸ™ï¸ é–‹å§‹éŒ„éŸ³');
                    this.startAudioTimer();

                } catch (error) {
                    this.addLog('error', `å•Ÿå‹•éŒ„éŸ³å¤±æ•—: ${error.message}`);
                    this.stopAudio();
                }
            }

            stopAudio() {
                this.isRecording = false;

                if (this.audioProcessor) {
                    this.audioProcessor.disconnect();
                    this.audioProcessor = null;
                }

                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }

                if (this.audioTimer) {
                    clearInterval(this.audioTimer);
                    this.audioTimer = null;
                }

                this.updateAudioStatus('å·²åœæ­¢', false);
                this.addLog('info', 'â¹ï¸ åœæ­¢éŒ„éŸ³');
                this.resetVisualizer();
            }

            startAudioTimer() {
                this.audioTimer = setInterval(() => {
                    if (this.isRecording && this.audioStartTime) {
                        const duration = (Date.now() - this.audioStartTime) / 1000;
                        document.getElementById('audioDuration').textContent = `${duration.toFixed(1)}s`;
                    }
                }, 100);
            }

            updateAudioStatus(status, isRecording) {
                document.getElementById('audioStatus').textContent = status;
                document.getElementById('startAudioBtn').disabled = isRecording || !this.isConnected;
                document.getElementById('stopAudioBtn').disabled = !isRecording;
                document.getElementById('audioChunksValue').textContent = this.messageCount.audioChunks;
            }

            updateVisualizer(audioData) {
                const bars = document.querySelectorAll('.audio-bar');
                const samples = 20;
                const step = Math.floor(audioData.length / samples);

                for (let i = 0; i < samples; i++) {
                    const sum = Math.abs(audioData[i * step]);
                    const height = Math.min(80, sum * 200);
                    bars[i].style.height = `${Math.max(5, height)}px`;
                }
            }

            resetVisualizer() {
                const bars = document.querySelectorAll('.audio-bar');
                bars.forEach(bar => {
                    bar.style.height = '5px';
                });
            }

            updateStats() {
                document.getElementById('sentCount').textContent = this.messageCount.sent;
                document.getElementById('receivedCount').textContent = this.messageCount.received;
                document.getElementById('audioChunks').textContent = this.messageCount.audioChunks;
            }

            addLog(type, content) {
                const logContainer = document.getElementById('logContainer');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;

                const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
                
                const typeLabel = {
                    'sent': 'ç™¼é€',
                    'received': 'æ¥æ”¶',
                    'error': 'éŒ¯èª¤',
                    'info': 'è³‡è¨Š'
                }[type] || 'æœªçŸ¥';

                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    <span class="log-type ${type}">${typeLabel}</span>
                    <span class="log-content">${this.escapeHtml(content)}</span>
                `;

                logContainer.appendChild(logEntry);

                // Auto scroll if enabled
                if (document.getElementById('autoScrollCheckbox').checked) {
                    logContainer.scrollTop = logContainer.scrollHeight;
                }

                // Limit log entries to prevent memory issues
                const maxLogs = 500;
                while (logContainer.children.length > maxLogs) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }

            clearLogs() {
                document.getElementById('logContainer').innerHTML = '';
                this.addLog('info', 'æ—¥èªŒå·²æ¸…é™¤');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the console
        const console = new WebSocketAdminConsole();
    </script>
</body>
</html>
